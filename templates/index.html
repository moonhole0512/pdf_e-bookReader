<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Book 라이브러리</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>E-Book 라이브러리</h1>
        <nav>
            <span>{{ g.user.username }}님</span>
            <a href="{{ url_for('logout') }}">로그아웃</a>
            <button id="scan-pdf-btn" class="scan-btn">PDF 스캔</button>
        </nav>
    </header>

    <main class="library-container">
        {% if last_read_file %}
        <section class="bookshelf">
            <h2>이어 읽기</h2>
            <div class="book-card-wrapper">
                {% set state = last_read_file.reading_state %}
                <div class="book-card last-read">
                    <a href="{{ url_for('reader', file_id=last_read_file.id) }}">
                        <img src="{{ last_read_file.cover_url or last_read_file.book.cover_url or 'https://placehold.co/300x450/2a2a2a/ffffff?text=' + (last_read_file.title or last_read_file.book.title) }}" alt="{{ last_read_file.title or last_read_file.book.title }}">
                        <div class="book-info">
                            <h3>{{ last_read_file.title or last_read_file.book.title }}</h3>
                            <p>{{ last_read_file.author or last_read_file.book.author }}</p>
                            <p>Vol. {{ last_read_file.volume_number }}</p>
                        </div>
                        {% if state and last_read_file.total_pages > 0 %}
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ (state.current_page / last_read_file.total_pages) * 100 }}%;"></div>
                        </div>
                        <span class="progress-text">{{ state.current_page }} / {{ last_read_file.total_pages }}</span>
                        {% endif %}
                    </a>
                    <button class="isbn-btn" data-file-id="{{ last_read_file.id }}" data-book-title="{{ last_read_file.title or last_read_file.book.title }}" data-volume-number="{{ last_read_file.volume_number }}">ISBN</button>
                </div>
            </div>
        </section>
        {% endif %}

        {% if all_groups %}
        <section class="bookshelf">
            <div class="bookshelf-header">
                <h2>모든 책</h2>
                <form action="{{ url_for('index') }}" method="GET" class="search-form">
                    <input type="text" name="search_query" placeholder="책 제목 검색..." value="{{ search_query or '' }}" autocomplete="off">
                    <button type="submit">검색</button>
                    <div id="autocomplete-results" class="autocomplete-results"></div>
                </form>
            </div>
            <div class="book-grid">
                {% for group in all_groups %}
                    <div class="book-card" 
                         data-is-group="true" 
                         data-volume-count="{{ group.volume_count }}" 
                         data-single-url="{{ url_for('reader', file_id=group.files[0].id) if group.volume_count == 1 else '' }}"
                         data-volumes='{{ group.files | tojson }}'
                         data-series-title="{{ group.book.title }}">
                        
                        <img src="{{ group.cover_file.cover_url or group.cover_file.book.cover_url or 'https://placehold.co/300x450/2a2a2a/ffffff?text=' + group.book.title }}" alt="{{ group.book.title }}">
                        
                        {% if group.volume_count > 1 %}
                        <div class="volume-badge">{{ group.volume_count }}권</div>
                        {% endif %}

                        <div class="book-info">
                            <h3>{{ group.book.title }}</h3>
                            <p>{{ group.cover_file.author or group.book.author }}</p>
                        </div>
                        {% if group.volume_count == 1 %}
                        <button class="isbn-btn" 
                                data-file-id="{{ group.files[0].id }}" 
                                data-book-title="{{ group.book.title }}" 
                                data-volume-number="{{ group.files[0].volume_number }}">ISBN</button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if reading_groups %}
        <section class="bookshelf">
            <h2>독서 중인 책</h2>
            <div class="book-grid">
                {% for group in reading_groups %}
                    <div class="book-card" 
                         data-is-group="true" 
                         data-volume-count="{{ group.volume_count }}" 
                         data-single-url="{{ url_for('reader', file_id=group.files[0].id) if group.volume_count == 1 else '' }}"
                         data-volumes='{{ group.files | tojson }}'
                         data-series-title="{{ group.book.title }}">
                        
                        <img src="{{ group.cover_file.cover_url or group.cover_file.book.cover_url or 'https://placehold.co/300x450/2a2a2a/ffffff?text=' + group.book.title }}" alt="{{ group.book.title }}">
                        
                        {% if group.volume_count > 1 %}
                        <div class="volume-badge">{{ group.volume_count }}권</div>
                        {% endif %}

                        <div class="book-info">
                            <h3>{{ group.book.title }}</h3>
                            <p>{{ group.cover_file.author or group.book.author }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if recommended_groups %}
        <section class="bookshelf">
            <h2>추천 책</h2>
            <div class="book-grid">
                {% for group in recommended_groups %}
                    <div class="book-card" 
                         data-is-group="true" 
                         data-volume-count="{{ group.volume_count }}" 
                         data-single-url="{{ url_for('reader', file_id=group.files[0].id) if group.volume_count == 1 else '' }}"
                         data-volumes='{{ group.files | tojson }}'
                         data-series-title="{{ group.book.title }}">
                        
                        <img src="{{ group.cover_file.cover_url or group.cover_file.book.cover_url or 'https://placehold.co/300x450/2a2a2a/ffffff?text=' + group.book.title }}" alt="{{ group.book.title }}">
                        
                        {% if group.volume_count > 1 %}
                        <div class="volume-badge">{{ group.volume_count }}권</div>
                        {% endif %}

                        <div class="book-info">
                            <h3>{{ group.book.title }}</h3>
                            <p>{{ group.cover_file.author or group.book.author }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </main>

    <div id="isbn-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modal-title">책 정보 업데이트</h2>
            <input type="hidden" id="modal-book-id">
            <div class="isbn-input-group">
                <input type="text" id="isbn-input" placeholder="ISBN-13 또는 ISBN-10 입력">
                <button id="isbn-search-btn">검색</button>
            </div>
            <hr>
            <div id="isbn-results"></div>
            <div class="modal-actions">
                <button id="isbn-register-btn" disabled>등록</button>
                <button id="modal-close-btn">닫기</button>
            </div>
        </div>
    </div>

    <div id="volume-select-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="volume-modal-title">권 선택</h2>
            <div id="volume-list" class="book-grid"></div>
            <div class="modal-actions">
                <button id="volume-modal-close-btn">닫기</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification"></div>

    <script src="{{ url_for('static', filename='js/library.js') }}"></script>
</body>
</html>
